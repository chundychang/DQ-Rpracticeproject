---
title: 'Dataquest Guided Project: Answering Business Questions using SQL'
author: "Cindy Zhang"
date: "9/8/2020"
output: 
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    code_folding: hide
    number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: yes
---
# Introduction

This is my solution to Dataquest's Guided Project from the Intermediate SQL in R course, which practices writing SQL queries to extract data from `chinook`, a database of sales for a fictional music store called Chinook. 

More details such as the RMD and csv files can be found in the [repository in GitHub](https://github.com/chundychang/DQ-Rpracticeproject/tree/master/SQL%20projects).

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, results = 'markup', message = F)
# knitr::opts_chunk$set(include = F)
knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

```{r pkg, include=FALSE}
library(knitr)
library(RSQLite)
library(DBI)
library(pander)
library(flextable)
library(magrittr)
library(dplyr)
library(purrr)
library(readr)
library(tidyverse)
library(tidyr)
library(tibble)
library(rlang)
library(DT)
library(stringr)
library(ggplot2)
options(stringsAsFactors = FALSE)
```

# Findings

## Step 1: Creating Helper Functions

```{r helper}
run_query <- function(q) {
  conn <- dbConnect(SQLite(), 'chinook.db')
  result <- dbGetQuery(conn, q)
  dbDisconnect(conn)
  return(result)
}
show_tables <- function() {
  q = "SELECT name, type FROM sqlite_master WHERE type IN ('table', 'view')"
  return(run_query(q))
}
show_tables()
```

## Step 2: Selecting Albums to Purchase

query: finds out which genres sell the most tracks in the USA; in absolute numbers and in percentages

```{r query}
album_query <- '
WITH usa_tracks_sold AS
   (
    SELECT il.* FROM invoice_line il
    INNER JOIN invoice i on il.invoice_id = i.invoice_id
    INNER JOIN customer c on i.customer_id = c.customer_id
    WHERE c.country = "USA"
   )
SELECT
    g.name genre,
    count(uts.invoice_line_id) tracks_sold,
    cast(count(uts.invoice_line_id) AS FLOAT) / (
        SELECT COUNT(*) from usa_tracks_sold
    ) percentage_sold
FROM usa_tracks_sold uts
INNER JOIN track t on t.track_id = uts.track_id
INNER JOIN genre g on g.genre_id = t.genre_id
GROUP BY 1
ORDER BY 2 DESC
LIMIT 10;
'

album_df <- data.frame(run_query(album_query))
```

```{r graph}
ggplot(data=album_df)+
  aes(x=genre, y=tracks_sold)+
  geom_bar(stat="identity")+
  geom_text(aes(label=tracks_sold), position=position_dodge(width=0.9), vjust=-0.25) +
  labs(title="Top 10 Best-Selling Genres by Total Album Sales")+
  theme(panel.background=element_rect(fill="white"), axis.line = element_line(size=0.25, colour = "black"))
```

Based on above results, Red Tone, Slim Jim Bites, and Meteor and the Girls

## Step 3: Analyzing Employee Sales Performance

## Step 4: Analyzing Sales by Country

## Step 5: Visualizing Sales by Country

## Step 6: Album vs. Individual Tracks

# Conclusion
